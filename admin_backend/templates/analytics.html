<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²æ–™éŠ·å”®æ’è¡Œæ¦œ</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            position: relative;
        }

        /* å·¦ä¸Šè§’æ™‚é–“é¡¯ç¤º */
        #current-time, #weather-info, #tomorrow-title, #tomorrow-weather {
            position: absolute;
            left: 20px;
            font-size: 16px;
            color: #6c757d;
            font-weight: bold;
        }

        #current-time {
            top: 10px;
        }

        #weather-info {
            top: 40px;
        }

        /* æ–°å¢çš„æ˜æ—¥å¤©æ°£é å ±æ¨™é¡Œ */
        #tomorrow-title {
            top: 80px;
            font-size: 15px;
            color: #495057;
            font-weight: bold;
        }

        /* æ–°å¢çš„æ˜æ—¥å¤©æ°£è³‡è¨Š */
        #tomorrow-weather {
            top: 110px;
        }

        h1.text-primary {
        margin-top: 100px; /* èª¿æ•´æ•¸å€¼ä¾†æ”¹è®Šé–“è· */
        }

        #chart-container {
            width: 100%;
            max-width: 90vw;
            height: auto;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: white;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="container text-center">

    <!-- é¡¯ç¤ºç¾åœ¨æ™‚é–“ -->
    <p id="current-time"></p>
    <!-- é¡¯ç¤ºä»Šå¤©å¤©æ°£è³‡è¨Š -->
    <p id="weather-info">å¤©æ°£è³‡è¨Šè¼‰å…¥ä¸­...</p>

    <!-- æ˜æ—¥å¤©æ°£é å ±æ¨™é¡Œ -->
    <p id="tomorrow-title">ğŸ“¢ æ˜æ—¥å¤©æ°£é å ±ï¼š</p>
    <!-- æ˜å¤©å¤©æ°£è³‡è¨Š -->
    <p id="tomorrow-weather">ğŸŒ¤ï¸ æ˜å¤©å¤©æ°£è¼‰å…¥ä¸­...</p>

    <!-- ç©ºç™½å€åŸŸ -->
    <div style="height: 50px;"></div>
    <div style="height: 50px;"></div>
    <div style="height: 50px;"></div>

    <!-- é æ¸¬éŠ·é‡æŒ‰éˆ• -->
    <div class="d-flex align-items-center" style="margin-top: 20px; margin-left: 10px;">
        <button id="predict-btn" class="btn btn-success">ğŸ“Š é æ¸¬æ˜æ—¥éŠ·é‡</button>
        <span id="prediction-result" class="ms-3 text-danger fw-bold"></span>
    </div>

    <div style="height: 50px;"></div> <!-- å¢åŠ ä¸€å€‹ 50px é«˜åº¦çš„ç©ºç™½å€åŸŸ -->


    <div class="d-flex align-items-center">
        <h2 class="text-muted me-5 fs-4">ğŸ¥¤ é£²æ–™éŠ·å”®æ’è¡Œæ¦œ</h2>
        <label for="days" class="form-label me-3">è«‹è¼¸å…¥å¤©æ•¸ï¼š</label>
        <input type="number" id="days" value="7" min="1" class="form-control" style="max-width: 100px;">
        <button class="btn btn-success ms-3" onclick="loadChart()">æŸ¥è©¢</button>
    </div>

    <!-- åœ–è¡¨é¡¯ç¤ºå€ -->
    <div id="chart-container">
        <p>è«‹è¼¸å…¥å¤©æ•¸å¾ŒæŒ‰ä¸‹æŒ‰éˆ•ä¾†é¡¯ç¤ºåœ–è¡¨</p>
    </div>

    <script>
        // æ›´æ–°ç•¶å‰æ™‚é–“
        function updateTime() {
            var now = new Date();
            var formattedTime = now.toLocaleString("zh-TW", { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit'
            });
            $("#current-time").text("ğŸ•“ ç¾åœ¨æ™‚é–“ï¼š" + formattedTime);
        }

        // æ›´æ–°ä»Šå¤©å¤©æ°£è³‡è¨Š
        function updateWeather() {
            $.ajax({
                url: "/api/weather",
                type: "GET",
                dataType: "json",
                success: function(data) {
                    var taichungStation = data.station;
                    var houliStation = data.location;
                    var weather = data.weather;
                    var temperature = data.temperature;

                    var weatherText = `ğŸ“ ${taichungStation} â†’ ${houliStation} | å¤©æ°£ï¼š${weather} | æº«åº¦ï¼š${temperature}Â°C`;
                    $("#weather-info").text(weatherText);
                },
                error: function() {
                    $("#weather-info").text("å¤©æ°£è³‡è¨Šè¼‰å…¥å¤±æ•—");
                }
            });
        }

        // æ›´æ–°æ˜å¤©å¤©æ°£è³‡è¨Š
        function updateTomorrowWeather() {
            $.ajax({
                url: "/api/tomorrow_weather",
                type: "GET",
                dataType: "json",
                success: function(data) {
                    var date = data.date;
                    var weather = data.weather;
                    var max_temp = data.max_temp;
                    var min_temp = data.min_temp;

                    var tomorrowText = `ğŸ“… ${date} | å¤©æ°£ï¼š${weather} | ğŸŒ¡ï¸ æœ€é«˜æº«ï¼š${max_temp}Â°C | æœ€ä½æº«ï¼š${min_temp}Â°C`;
                    $("#tomorrow-weather").text(tomorrowText);
                },
                error: function() {
                    $("#tomorrow-weather").text("ğŸŒ¤ï¸ æ˜å¤©å¤©æ°£è¼‰å…¥å¤±æ•—");
                }
            });
        }

        // è¼‰å…¥åœ–è¡¨
        function loadChart() {
            var days = $("#days").val();

            $.ajax({
                url: "/api/sales_chart",
                type: "GET",
                data: { days: days },
                dataType: "html",
                success: function(response) {
                    $("#chart-container").html(response);
                },
                error: function() {
                    alert("ç„¡æ³•å–å¾—æ•¸æ“šï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            });
        }

        $(document).ready(function() {
            $("#predict-btn").click(function() {
                $("#prediction-result")
                    .removeClass("text-danger text-success")
                    .addClass("text-warning")
                    .html("ğŸ“Š é æ¸¬ä¸­...");

                $.ajax({
                    url: "/api/predict_sales",
                    type: "GET",
                    dataType: "json",
                    success: function(data) {
                        console.log("Response received:", data); // è¨˜éŒ„ API å›æ‡‰

                        // **ä¿®æ­£è®Šæ•¸åç¨±**
                        if (!data || !data.daily_total_sales || !data.top_6_drinks) {
                            $("#prediction-result")
                                .removeClass("text-warning")
                                .addClass("text-danger")
                                .text("âŒ ç„¡æ³•ç²å–é æ¸¬çµæœ");
                            return;
                        }

                        var resultText = `ğŸ“Š é æ¸¬ç¸½éŠ·é‡ï¼š<strong>${data.daily_total_sales}</strong> æ¯<br>ğŸ¥¤ æ¨è–¦æš¢éŠ·é£²å“ï¼š<strong>${data.top_6_drinks.join(", ")}</strong>`;
                        $("#prediction-result")
                            .removeClass("text-warning text-danger")
                            .addClass("text-success")
                            .html(resultText);
                    },
                    error: function(xhr, status, error) {
                        console.log("AJAX Error:", status, error, xhr.responseText); // é¡¯ç¤ºéŒ¯èª¤ç´°ç¯€
                        $("#prediction-result")
                            .removeClass("text-warning")
                            .addClass("text-danger")
                            .text("âŒ ç„¡æ³•ç²å–é æ¸¬çµæœ");
                    }
                });
            });
        });


        // å•Ÿå‹•æ™‚é–“ & å¤©æ°£æ›´æ–°
        setInterval(updateTime, 1000);
        updateTime();
        setInterval(updateWeather, 300000); // æ¯ 5 åˆ†é˜æ›´æ–°ä¸€æ¬¡
        updateWeather();
        setInterval(updateTomorrowWeather, 300000); // æ¯ 5 åˆ†é˜æ›´æ–°ä¸€æ¬¡
        updateTomorrowWeather();
    </script>
</body>
</html>
